<mat-card appearance="outlined">
  <mat-card-content>
    <div class="mb-3">
      <h2 class="h5 mb-1" i18n>AI Portfolio Assistant</h2>
      <p class="mb-0 text-muted" i18n>
        Ask portfolio, risk, and market questions with cited results.
      </p>
    </div>

    @if (!hasPermissionToReadAiPrompt) {
      <div class="alert alert-warning mb-0" role="alert" i18n>
        You need AI prompt permission to use this assistant.
      </div>
    } @else {
      <div class="d-flex flex-wrap mb-3 prompt-list">
        @for (prompt of starterPrompts; track prompt) {
          <button
            class="mr-2 mb-2"
            mat-stroked-button
            type="button"
            (click)="onSelectStarterPrompt(prompt)"
          >
            {{ prompt }}
          </button>
        }
      </div>

      <mat-form-field class="w-100">
        <mat-label i18n>Ask about your portfolio</mat-label>
        <textarea
          aria-label="Ask about your portfolio"
          i18n-aria-label
          matInput
          rows="3"
          [(ngModel)]="query"
          [disabled]="isSubmitting"
          (keydown.enter)="onSubmitFromKeyboard($event)"
        ></textarea>
      </mat-form-field>

      <div class="align-items-center d-flex mb-3">
        <button
          color="primary"
          mat-flat-button
          type="button"
          [disabled]="isSubmitting || !query?.trim()"
          (click)="onSubmit()"
        >
          <ng-container i18n>Send</ng-container>
        </button>
        @if (isSubmitting) {
          <mat-spinner class="ml-3" color="accent" [diameter]="20" />
        }
      </div>

      @if (errorMessage) {
        <div class="alert alert-danger mb-3" role="alert">
          {{ errorMessage }}
        </div>
      }

      <div aria-live="polite" aria-relevant="additions text" class="chat-log" role="log">
        @for (message of chatMessages; track message.id) {
          <div
            class="chat-message mb-3 p-3 rounded"
            [class.assistant]="message.role === 'assistant'"
            [class.user]="message.role === 'user'"
          >
            <div class="chat-message-header mb-1 text-muted">
              <span class="role-label text-uppercase">{{ getRoleLabel(message.role) }}</span>
              <span class="ml-2 timestamp">{{
                message.createdAt | date: 'shortTime'
              }}</span>
            </div>
            <div class="chat-message-content">{{ message.content }}</div>

            @if (message.response) {
              <div class="chat-metadata mt-2">
                <div class="confidence mb-2">
                  <strong i18n>Confidence</strong>:
                  {{ message.response.confidence.score * 100 | number: '1.0-0'
                  }}% ({{ message.response.confidence.band }})
                </div>

                @if (message.response.citations.length > 0) {
                  <div class="mb-2">
                    <strong i18n>Citations</strong>
                    <ul class="mb-0 pl-3">
                      @for (citation of message.response.citations; track $index) {
                        <li>
                          <span class="font-weight-bold">{{
                            citation.source
                          }}</span>
                          -
                          {{ citation.snippet }}
                        </li>
                      }
                    </ul>
                  </div>
                }

                @if (message.response.verification.length > 0) {
                  <div class="mb-2">
                    <strong i18n>Verification</strong>
                    <ul class="mb-0 pl-3">
                      @for (check of message.response.verification; track $index) {
                        <li>
                          {{ check.status }} - {{ check.check }}:
                          {{ check.details }}
                        </li>
                      }
                    </ul>
                  </div>
                }

                @if (message.response.observability) {
                  <div class="mb-2">
                    <strong i18n>Observability</strong>:
                    <span class="ml-1"
                      >{{ message.response.observability.latencyInMs }}ms,
                      ~{{
                        message.response.observability.tokenEstimate.total
                      }}
                      tokens</span
                    >
                  </div>
                }

                @if (message.feedback) {
                  <div class="align-items-center d-flex feedback-controls">
                    <button
                      class="mr-2"
                      mat-stroked-button
                      type="button"
                      [disabled]="
                        message.feedback.isSubmitting || !!message.feedback.rating
                      "
                      (click)="onRateResponse({ index: $index, rating: 'up' })"
                    >
                      <ng-container i18n>Helpful</ng-container>
                    </button>
                    <button
                      mat-stroked-button
                      type="button"
                      [disabled]="
                        message.feedback.isSubmitting || !!message.feedback.rating
                      "
                      (click)="onRateResponse({ index: $index, rating: 'down' })"
                    >
                      <ng-container i18n>Needs work</ng-container>
                    </button>

                    @if (message.feedback.isSubmitting) {
                      <span class="ml-2 text-muted" i18n>Saving feedback...</span>
                    } @else if (message.feedback.feedbackId) {
                      <span class="ml-2 text-muted" i18n>Feedback saved</span>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>
